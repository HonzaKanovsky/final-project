<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Camera Client</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white flex flex-col items-center min-h-screen p-4">

  <h1 class="text-3xl font-bold mb-6">Camera Client</h1>

  <div id="video-container"
    class="relative w-full max-w-md aspect-video bg-black flex items-center justify-center rounded overflow-hidden shadow-lg">
    <video id="video" autoplay muted playsinline class="w-full h-full object-cover rounded hidden"></video>

    <div id="disconnected-placeholder"
      class="absolute inset-0 flex flex-col items-center justify-center bg-black text-white text-xl font-semibold">
      <img
        src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcmY3aWpkMmJkNjAxYzEwdTltNmRtNDR1enh1dG02YXk4bGw1ajRxcSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/bGdMdnVwLYZOYSu7jk/giphy.gif"
        alt="Snow Noise" class="w-full h-full object-cover" />
      <div class="absolute bottom-4 bg-black bg-opacity-50 px-3 py-1 rounded text-sm">Disconnected</div>
    </div>
  </div>

  <p id="ip-display" class="mt-4 text-sm text-gray-400"></p>

  <button id="toggle-btn" class="mt-6 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded text-lg font-semibold transition">
    Start Camera
  </button>

  <script>
    const video = document.getElementById('video');
    const placeholder = document.getElementById('disconnected-placeholder');
    const toggleBtn = document.getElementById('toggle-btn');
    const ipDisplay = document.getElementById('ip-display');

    let stream = null;
    let ws = null;
    let frameInterval = null;
    let cameraActive = false;

    function updatePlaceholder(showPlaceholder) {
      video.style.display = showPlaceholder ? 'none' : 'block';
      placeholder.style.display = showPlaceholder ? 'flex' : 'none';
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        updatePlaceholder(false);
        toggleBtn.textContent = 'Stop Camera';
        cameraActive = true;

        startWebSocket(stream);

      } catch (err) {
        console.error('Error accessing camera:', err);
        alert('Cannot access camera.');
      }
    }

    function stopCamera() {
      if (frameInterval) {
        clearInterval(frameInterval);
        frameInterval = null;
      }
      if (ws) {
        ws.close();
        ws = null;
      }
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      video.srcObject = null;
      updatePlaceholder(true);
      toggleBtn.textContent = 'Start Camera';
      ipDisplay.textContent = '';
      cameraActive = false;
    }

    function startWebSocket(stream) {
      const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
      ws = new WebSocket(`${protocol}://${location.host}/?type=camera`);
      ws.binaryType = 'arraybuffer';

      ws.onopen = async () => {
        console.log('WebSocket connected (camera)');

        try {
          const response = await fetch('https://api.ipify.org?format=json');
          const { ip } = await response.json();
          ws.send(JSON.stringify({ type: 'ip', ip }));
        } catch (err) {
          console.error('Failed to fetch public IP:', err);
        }

        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);

        frameInterval = setInterval(async () => {
          if (ws.readyState !== WebSocket.OPEN) return;
          try {
            const bitmap = await imageCapture.grabFrame();
            const canvas = document.createElement('canvas');
            canvas.width = bitmap.width;
            canvas.height = bitmap.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(bitmap, 0, 0);
            canvas.toBlob(blob => {
              if (blob) {
                blob.arrayBuffer().then(buffer => {
                  ws.send(buffer);
                });
              }
            }, 'image/jpeg', 0.7);
          } catch (e) {
            console.error('Frame capture error:', e);
          }
        }, 100); // 10 FPS
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === 'ip') {
            ipDisplay.textContent = `Your IP: ${msg.ip}`;
          }
        } catch (e) {
          // Ignore binary messages
        }
      };

      ws.onerror = (e) => console.error('WebSocket error (camera):', e);
      ws.onclose = () => {
        console.log('WebSocket closed (camera)');
        stopCamera();
      };
    }

    toggleBtn.onclick = () => {
      if (cameraActive) {
        stopCamera();
      } else {
        startCamera();
      }
    };

    updatePlaceholder(true);
  </script>
</body>

</html>